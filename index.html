<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Location Tracker Map</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
        #map { height: 100vh; width: 100%; }

        .info-window { padding: 10px; min-width: 200px; }
        .info-window h3 {
            color: #333; margin-bottom: 10px; font-size: 18px;
            border-bottom: 2px solid #4285f4; padding-bottom: 5px;
        }
        .info-window p { margin: 5px 0; color: #666; font-size: 14px; }
        .info-window strong { color: #333; display: inline-block; width: 80px; }
        .phone-number { color: #4285f4; text-decoration: none; font-weight: 500; }
        .phone-number:hover { text-decoration: underline; }

        .loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 1000; background: white; padding: 30px;
            border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .loading.hidden { display: none; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #4285f4; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .admin-link {
            position: fixed; bottom: 20px; right: 20px; background: #4285f4; color: white;
            padding: 10px 20px; border-radius: 25px; text-decoration: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100; font-size: 14px;
            transition: all 0.3s ease;
        }
        .admin-link:hover { background: #357ae8; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        .parent-info { margin-top: 5px; padding-top: 5px; border-top: 1px solid #eee; }
        .parent-name { color: #555; font-size: 13px; font-style: italic; }

        /* My Location button */
        .locate-link {
            position: fixed; bottom: 20px; left: 20px; background: #34a853; color: white;
            padding: 10px 20px; border-radius: 25px; text-decoration: none; border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 100; font-size: 14px;
            transition: all 0.3s ease; cursor: pointer;
        }
        .locate-link:hover { background: #2d9447; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

          .group-marker{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 56px;              /* ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© */
      height: 56px;
      border-radius: 50%;
      background: #4285f4;      /* Ÿäÿ™ÿ®ÿØŸëŸÑ ÿ≠ÿ≥ÿ® ÿ£ŸàŸÑ ŸÑŸàŸÜ ÿ®ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© */
      color: #fff;
      border: 2px solid #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 6px;
      text-align: center;
      user-select: none;
      font-weight: 600;
  }
  .group-marker .names{
      font-size: 11px;
      line-height: 1.1;
      white-space: normal;      /* ŸÑŸÜÿ≥ŸÖÿ≠ ÿ®ÿ£ÿ≥ÿ∑ÿ± ŸÖÿ™ÿπÿØÿØÿ© */
      word-break: break-word;
  }

    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading map data...</p>
    </div>

    <div id="map"></div>

    <!-- Admin panel link -->
    <a href="admin.html" class="admin-link">Admin Panel</a>

    <!-- My location button -->
    <button id="locateBtn" class="locate-link">üìç My Location</button>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration (from your project)
        const firebaseConfig = {
            apiKey: "AIzaSyAsltkrj6N-L1IEaJEbdHDWYEC_F6HJSrE",
            authDomain: "map-b012a.firebaseapp.com",
            projectId: "map-b012a",
            storageBucket: "map-b012a.firebasestorage.app",
            messagingSenderId: "955802242108",
            appId: "1:955802242108:web:44ee5523ee737094440739",
            measurementId: "G-XN0RBYP3Q7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map;
        let markers = [];
        let infoWindow;

        // NEW: user location tracking state
        let userMarker = null;
        let accuracyCircle = null;
        let watchId = null;
        let firstCenterDone = false;

        function initMap() {
            // Initialize map centered on Beirut by default
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 10,
                center: { lat: 33.8938, lng: 35.5018 },
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: true,
                zoomControl: true
            });

            infoWindow = new google.maps.InfoWindow();

            // Start loading Firestore markers
            loadMarkers();

            // Ask for location and start tracking (works on HTTPS or localhost)
            if (navigator.geolocation) {
                startTrackingMyLocation();
            } else {
                console.warn('Geolocation not supported by this browser.');
            }
        }

        function loadMarkers() {
  const unsubscribe = db.collection('markers').onSnapshot((snapshot) => {
    // ÿ¥ŸäŸÑ ÿßŸÑÿπŸÑÿßŸÖÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
    markers.forEach(m => {
      if (m.setMap) m.setMap(null);   // ŸÑŸÑŸÄ Marker ÿßŸÑÿπÿßÿØŸä
      else m.map = null;              // ŸÑŸÑŸÄ AdvancedMarkerElement
    });
    markers = [];

    let bounds = new google.maps.LatLngBounds();
    let hasMarkers = false;

    // 1) ÿ¨ŸÖŸëÿπ ÿ≠ÿ≥ÿ® ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™
    const groups = new Map();
    snapshot.forEach((doc) => {
      const data = doc.data();
      if (typeof data.lat !== 'number' || typeof data.lng !== 'number') return;

      const key = `${Number(data.lat).toFixed(6)},${Number(data.lng).toFixed(6)}`;
      if (!groups.has(key)) {
        groups.set(key, { position: { lat: data.lat, lng: data.lng }, people: [] });
      }
      groups.get(key).people.push({ id: doc.id, ...data });
    });

    // 2) ÿ£ŸÜÿ¥ÿ¶ Advanced Marker ŸÑŸÉŸÑ ŸÖÿ¨ŸÖŸàÿπÿ©
    groups.forEach((group) => {
      const pos = group.position;
      const names = group.people.map(p => p.displayName || p.fullName || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ');

      // ÿπŸÜÿµÿ± HTML ŸÑŸÑÿØÿßÿ¶ÿ±ÿ© + ÿßŸÑÿ£ÿ≥ŸÖÿßÿ° ÿ™ÿ≠ÿ™ ÿ®ÿπÿ∂
      const el = document.createElement('div');
      el.className = 'group-marker';
      el.style.background = group.people[0]?.color || '#4285f4';
      el.innerHTML = `<div class="names">${names.join('<br>')}</div>`;

      // Advanced Marker (ŸäÿØÿπŸÖ HTML)
      const advMarker = new google.maps.marker.AdvancedMarkerElement({
        map,
        position: pos,
        content: el
      });

      // ŸÜÿßŸÅÿ∞ÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™: ÿ™ŸÅÿßÿµŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ÿ®ŸÜŸÅÿ≥ ÿßŸÑŸÖŸàŸÇÿπ
      advMarker.addListener('gmp-click', () => {
        const peopleHtml = group.people.map((p) => {
          const phoneRows = [];
          if (p.motherPhone) phoneRows.push(`<p><strong>Mother:</strong> <a href="tel:${p.motherPhone}" class="phone-number">${p.motherPhone}</a></p>`);
          if (p.fatherPhone) phoneRows.push(`<p><strong>Father:</strong> <a href="tel:${p.fatherPhone}" class="phone-number">${p.fatherPhone}</a></p>`);
          if (p.personPhone) phoneRows.push(`<p><strong>Person:</strong> <a href="tel:${p.personPhone}" class="phone-number">${p.personPhone}</a></p>`);

          let parentInfo = '';
          if (p.motherName || p.fatherName) {
            parentInfo = '<div class="parent-info">';
            if (p.motherName) parentInfo += `<p class="parent-name">Mother: ${p.motherName}</p>`;
            if (p.fatherName) parentInfo += `<p class="parent-name">Father: ${p.fatherName}</p>`;
            parentInfo += '</div>';
          }

          const created = p.createdAt?.toDate ? new Date(p.createdAt.toDate()) : null;
          return `
            <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px">
              <h3 style="margin:0 0 6px 0">${p.fullName || p.displayName || 'ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}</h3>
              ${phoneRows.join('')}
              ${parentInfo}
              <p><strong>Added:</strong> ${created ? created.toLocaleDateString() : 'Unknown'}</p>
            </div>
          `;
        }).join('');

        infoWindow.setContent(`<div class="info-window">${peopleHtml}</div>`);
        infoWindow.setPosition(pos);
        infoWindow.open({ map });
      });

      markers.push(advMarker);
      bounds.extend(pos);
      hasMarkers = true;
    });

    // 3) ÿ∂ÿ®Ÿëÿ∑ ÿßŸÑÿ•ÿ∑ÿßÿ± ÿπŸÑŸâ ÿßŸÑŸÉŸÑ + ÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÑÿ≤ŸàŸÖ
    if (hasMarkers) {
      map.fitBounds(bounds);
      const listener = google.maps.event.addListener(map, "idle", function () {
        if (map.getZoom() > 16) map.setZoom(16);
        google.maps.event.removeListener(listener);
      });
    }

    // ÿ£ÿÆŸÅŸä ÿßŸÑŸÑŸàÿØŸäŸÜÿ∫
    document.getElementById('loading').classList.add('hidden');
  }, (error) => {
    console.error("Error loading markers:", error);
    document.getElementById('loading').innerHTML = '<p style="color: red;">Error loading map data. Please refresh the page.</p>';
  });

  return unsubscribe;
}

        // === NEW: Live location tracking ===
        function startTrackingMyLocation() {
            if (!navigator.geolocation) return;
            if (watchId !== null) return; // already tracking

            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, accuracy } = pos.coords;
                    const latLng = { lat: latitude, lng: longitude };

                    if (!userMarker) {
                        // Blue dot for user
                        userMarker = new google.maps.Marker({
                            position: latLng,
                            map,
                            title: 'You are here',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#1a73e8',
                                fillOpacity: 1,
                                strokeColor: '#ffffff',
                                strokeWeight: 2
                            },
                            zIndex: 9999
                        });

                        // Accuracy circle
                        accuracyCircle = new google.maps.Circle({
                            strokeColor: '#1a73e8',
                            strokeOpacity: 0.2,
                            strokeWeight: 1,
                            fillColor: '#1a73e8',
                            fillOpacity: 0.1,
                            map,
                            center: latLng,
                            radius: accuracy || 0
                        });
                    } else {
                        userMarker.setPosition(latLng);
                        if (accuracyCircle) {
                            accuracyCircle.setCenter(latLng);
                            accuracyCircle.setRadius(accuracy || 0);
                        }
                    }

                    // Center on first fix
                    if (!firstCenterDone) {
                        map.panTo(latLng);
                        map.setZoom(Math.max(map.getZoom(), 14));
                        firstCenterDone = true;
                    }
                },
                (err) => {
                    console.warn('Geolocation error:', err);
                    // Optional: UX message here if needed
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
            );
        }

        function stopTrackingMyLocation() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        // Recenter to user when clicking the button
        document.getElementById('locateBtn').addEventListener('click', () => {
            if (!navigator.geolocation) return;
            startTrackingMyLocation();
            if (userMarker) {
                map.panTo(userMarker.getPosition());
                map.setZoom(Math.max(map.getZoom(), 14));
            }
        });
    </script>

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXtPIX97azfHXWr8I8fNStWe4ZhqoJDrI&callback=initMap"></script>
</body>
</html>
